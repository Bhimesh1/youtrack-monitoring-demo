{
  "__inputs": [
    {
      "name": "DS_PROMETHEUS",
      "label": "Prometheus",
      "description": "",
      "type": "datasource",
      "pluginId": "prometheus",
      "pluginName": "Prometheus"
    }
  ],
  "__requires": [
    { "type": "grafana", "id": "grafana", "name": "Grafana", "version": "10.0.0" },
    { "type": "panel", "id": "timeseries", "name": "Time series", "version": "" },
    { "type": "panel", "id": "gauge", "name": "Gauge", "version": "" },
    { "type": "panel", "id": "bargauge", "name": "Bar gauge", "version": "" },
    { "type": "panel", "id": "table", "name": "Table", "version": "" },
    { "type": "datasource", "id": "prometheus", "name": "Prometheus", "version": "2.0.0" }
  ],
  "annotations": { "list": [ { "builtIn": 1, "type": "dashboard", "name": "Annotations & Alerts", "hide": true } ] },
  "editable": true,
  "graphTooltip": 0,
  "panels": [
    {
      "id": 1,
      "type": "timeseries",
      "title": "CPU usage by instance (%)",
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "gridPos": { "h": 9, "w": 24, "x": 0, "y": 0 },
      "targets": [
        { "refId": "A", "editorMode": "code", "expr": "cpu_usage{job=~\"$job\",instance=~\"$instance\"}", "legendFormat": "{{instance}}", "format": "time_series" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "thresholds": { "mode": "percentage", "steps": [ { "color": "green" }, { "color": "#EAB839", "value": 50 }, { "color": "red", "value": 80 } ] }
        },
        "overrides": []
      },
      "options": { "legend": { "showLegend": true } }
    },
    {
      "id": 2,
      "type": "gauge",
      "title": "Average CPU usage (%)",
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "gridPos": { "h": 7, "w": 8, "x": 0, "y": 9 },
      "targets": [
        { "refId": "A", "editorMode": "code", "expr": "avg(cpu_usage{job=~\"$job\",instance=~\"$instance\"})", "format": "time_series" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percent", "min": 0, "max": 100,
          "thresholds": { "mode": "percentage", "steps": [ { "color": "green", "value": 0 }, { "color": "#EAB839", "value": 50 }, { "color": "red", "value": 80 } ] }
        },
        "overrides": []
      }
    },
    {
      "id": 3,
      "type": "bargauge",
      "title": "Top 5 peak CPU by instance (range)",
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "gridPos": { "h": 7, "w": 8, "x": 8, "y": 9 },
      "options": { "orientation": "horizontal", "displayMode": "gradient" },
      "targets": [
        { "refId": "A", "editorMode": "code", "expr": "topk(5, max_over_time(cpu_usage{job=~\"$job\"}[$__range]))", "legendFormat": "{{instance}}", "format": "time_series" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percent", "min": 0, "max": 100,
          "thresholds": { "mode": "percentage", "steps": [ { "color": "green", "value": 0 }, { "color": "#EAB839", "value": 50 }, { "color": "red", "value": 80 } ] }
        },
        "overrides": []
      }
    },
    {
      "id": 4,
      "type": "table",
      "title": "Current vs 5m avg per instance",
      "datasource": { "type": "prometheus", "uid": "${DS_PROMETHEUS}" },
      "gridPos": { "h": 7, "w": 8, "x": 16, "y": 9 },
      "targets": [
        { "refId": "A", "editorMode": "code", "expr": "cpu_usage{job=~\"$job\",instance=~\"$instance\"}", "legendFormat": "current", "format": "time_series" },
        { "refId": "B", "editorMode": "code", "expr": "avg_over_time(cpu_usage{job=~\"$job\",instance=~\"$instance\"}[5m])", "legendFormat": "avg_5m", "format": "time_series" }
      ],
      "transformations": [ { "id": "merge" } ],
      "options": { "showHeader": true }
    }
  ],
  "schemaVersion": 38,
  "style": "dark",
  "tags": ["prometheus", "cpu", "demo"],
  "templating": {
    "list": [
      { "name": "datasource", "type": "datasource", "label": "Datasource", "query": "prometheus", "refresh": 1, "current": { "selected": true, "text": "Prometheus", "value": "${DS_PROMETHEUS}" } },
      { "name": "job", "type": "query", "label": "job", "datasource": "${DS_PROMETHEUS}", "query": "label_values(cpu_usage, job)", "refresh": 2, "includeAll": true, "multi": true },
      { "name": "instance", "type": "query", "label": "instance", "datasource": "${DS_PROMETHEUS}", "query": "label_values(cpu_usage{job=~\"$job\"}, instance)", "refresh": 2, "includeAll": true, "multi": true }
    ]
  },
  "time": { "from": "now-6h", "to": "now" },
  "timezone": "browser",
  "title": "CPU Usage (cpu_usage)",
  "uid": "cpu-usage-demo",
  "version": 1
}
